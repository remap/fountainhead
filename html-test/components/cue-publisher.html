<template>
  <p id="cue-title" class="video-control-text"></p>
  <p id="cue-description" class="video-control-desc"></p>
  <p id="cue-chunk" class="video-control-chunk"></p>
</template>

<script>
  var componentObject = new window.ComponentObject(document, window);
  var componentName = 'com-cue-publisher';
  
  function onCreate(createdElement) {
    createdElement.ndnPublisherComponentObject = new window.NDNPublisherComponentObject(createdElement, window);
    createdElement.ndnPublisherComponentObject.parseParameters();
    
    createdElement.youtubeObject = new window.YoutubeObject();
    
    createdElement.showid = createdElement.getAttributeByListName(['showid'], window.showid);
    var cueTitle = createdElement.getAttributeByListName(['cueTitle', 't'], '');
    var description = createdElement.getAttributeByListName(['description', 'desc'], '');
    var cueFolder = createdElement.getAttributeByListName(['cueFolder'], window.cueFolder);
    
    createdElement.content = createdElement.getAttributeByListName(['content'], '');
    createdElement.cueId = createdElement.getAttributeByListName(['cid'], '-1');
    
    createdElement.titleElement = createdElement.shadowRoot.querySelector('#cue-title');
    createdElement.descElement = createdElement.shadowRoot.querySelector('#cue-description');
    createdElement.chunkElement = createdElement.shadowRoot.querySelector('#cue-chunk');
    
    createdElement.titleElement.textContent = cueTitle;
    createdElement.descElement.textContent = description;
    
    componentObject.applyStyleFromParentDocumentAll(createdElement);
    
    // If content is not defined explicitly in the script, we try to load the content JSON from a certain spot on serverside.
    if (createdElement.content === undefined || createdElement.content == '') {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', cueFolder + createdElement.cueId + '.json', true);
      xhr.onload = function (thisElement) {
        createdElement.content = this.responseText;
        return function() {
          registerEvents(thisElement);
        };
      } (createdElement);
      xhr.send();
    }
  }
  
  function registerEvents(createdElement) {
    // Preview display is disabled because most of the cues don't have the old JSON format url1
    try {
      var cueContent = JSON.parse(createdElement.content);
      
      createdElement.titleElement.addEventListener('mouseover', function() {
        // Note: after the cue publishing discussion, it's possible that URL's not exposed here; 
        // getting rid of the preview temporarily
        if (cueContent.yt1 != undefined && cueContent.yt1.URL != undefined) {
          createdElement.chunkElement.innerHTML = '<img src=\"http://img.youtube.com/vi/' + createdElement.youtubeObject.youtubeKeyParser(cueContent.yt1.URL) + '/0.jpg\"></img>';
        } else {
          console.log(componentName + ': no video url provided for this cue');
        }
      });
    
      createdElement.titleElement.addEventListener('mouseout', function() {
        createdElement.chunkElement.innerHTML = '';
      });
    } catch (error) {
      console.log(componentName + ' : ' + error);
    }
    
    createdElement.titleElement.addEventListener('click', function() {
      // TODO: referencing namePrefix like this is not ideal
      var dataName = new Name(createdElement.ndnPublisherComponentObject.namePrefix);
      // Note: for now, the names are hard-coded, since namespace design is not fully discussed
      var cueComponent = new Name('cues');
      var nameSuffix = new Name(createdElement.cueId);
      dataName.append(createdElement.showid).append(cueComponent).appendVersion((new Date).getTime()).append(nameSuffix);

      createdElement.ndnPublisherComponentObject.publishContent(dataName, createdElement.content, false);
    });
  }
  
  componentObject.createComponent(componentName, onCreate);
</script>