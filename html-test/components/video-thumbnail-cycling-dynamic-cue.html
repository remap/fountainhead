<template>
  <p id="cue-title" class="cue-title"></p>
  
  <p style="margin:1.3em auto; width: 400px">
    <a id="cue-load" class="video-control-text"></a>
    <a id="cue-go" class="video-control-text text-large"></a>
  </p>
  
  <p id="cue-description" class="video-control-desc"></p>
  <p id="cue-chunk" class="video-control-chunk"></p>
</template>

<script>
  var componentObject = new window.ComponentObject(document, window);
  var componentName = 'com-video-thumbnail-cycling-dynamic-cue';
  
  function onCreate(createdElement) {
    createdElement.ndnPublisherComponentObject = new window.NDNPublisherComponentObject(createdElement, window);
    createdElement.ndnPublisherComponentObject.parseParameters();
    
    createdElement.youtubeObject = new window.YoutubeObject();
    createdElement.dbObject = new window.DBObject('http://archive-dev.remap.ucla.edu/app');
    
    // This show-id in NDN name is different from the show-id field in database
    var defaultShowId = 'default-show';
    if (window.hasOwnProperty('showid')) {
      defaultShowId = window.showid;
    }
    
    createdElement.showid = createdElement.getAttributeByListName(['showid'], defaultShowId);
    var cueTitle = createdElement.getAttributeByListName(['cueTitle', 't'], '');
    var description = createdElement.getAttributeByListName(['description', 'desc'], '');
    
    // The number of videos we pick from each neighborhood query to form the playlist
    var resultLength = createdElement.getAttributeByListName(['playlistLength', 'l'], '3');
    
    createdElement.content = createdElement.getAttributeByListName(['content'], '');
    if (createdElement.content !== '') {
      console.log(componentName + ': content definition exists for dynamic cue.');
    }
    
    createdElement.cueId = createdElement.getAttributeByListName(['cid'], '-1');
    createdElement.cueGoing = false;
    createdElement.cueReady = false;
    
    createdElement.titleElement = createdElement.shadowRoot.querySelector('#cue-title');
    createdElement.descElement = createdElement.shadowRoot.querySelector('#cue-description');
    createdElement.chunkElement = createdElement.shadowRoot.querySelector('#cue-chunk');
    
    createdElement.loadElement = createdElement.shadowRoot.querySelector('#cue-load');
    createdElement.goElement = createdElement.shadowRoot.querySelector('#cue-go');
    //createdElement.unloadElement = createdElement.shadowRoot.querySelector('#cue-unload');
    
    createdElement.titleElement.textContent = createdElement.cueId + ' : ' + cueTitle;
    createdElement.descElement.textContent = description;
    
    createdElement.loadElement.textContent = 'stand by';
    createdElement.goElement.textContent = 'GO';
    
    componentObject.applyStyleFromParentDocumentAll(createdElement);
    
    // Hardcoded tags and projector door numbers
    var doorMapping = {
      'felix': 'natural',    // c1
      'eddie': 'bold',       // c2
      'rachel': 'longbeach', // b1
      'sheena': 'freeway'    // b2
    }
    
    createdElement.videoMapping = {
      'felix': [],    // c1
      'eddie': [],       // c2
      'rachel': [], // b1
      'sheena': []    // b2
    }
    
    var receivedCnt = 0;
    
    for (item in doorMapping) {
      var queryStr = 'select key, tags, description from media where tags contains \'' + doorMapping[item] + '\'';
      createdElement.dbObject.postToDB(queryStr, function (item) {
        return function (responseText) {
          if (responseText === '[]') {
            console.log('No entries found');
          } else {
            var responseObj = JSON.parse(responseText);
            for (var i = 0; i < responseObj.length; i++) {
              createdElement.videoMapping[item].push(responseObj[i][0]);
            }
          }
          receivedCnt ++;
          if (receivedCnt == Object.keys(doorMapping).length) {
            // TODO: both can mark cue as ready while cue actually may be loading, to be fixed
            createdElement.cueReady = true;
          }
        }
      } (item));
    }
    
    if (createdElement.content === undefined || createdElement.content == '') {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', cueFolder + createdElement.cueId + '.json', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          createdElement.cueContent = JSON.parse(xhr.responseText);
          createdElement.cueReady = true;
        }
      };
      xhr.send();
    }
    
    registerEvents(createdElement);
  }
  
  // Hardcoded door state
  function publishDoors(jsonObj, createdElement) {
    // B1
    if (jsonObj.nodeArgs.nodeB.tGo.doors['0'].composer.pipeline1.videoUrl !== undefined) {
      if (createdElement.videoMapping['rachel']) {
        var randIdx = Math.floor(Math.random() * createdElement.videoMapping['rachel'].length);
        jsonObj.nodeArgs.nodeB.tGo.doors['0'].composer.pipeline1.videoUrl = 'http://img.youtube.com/vi/' + createdElement.videoMapping['rachel'][randIdx] + '/0.jpg';
      } else {
        console.log('Rachel does not have an image');
      }
    } else {
      console.log('Rachel unexpected json');
    }
    // B2
    if (jsonObj.nodeArgs.nodeB.tGo.doors['1'].composer.pipeline1.videoUrl !== undefined) {
      if (createdElement.videoMapping['sheena']) {
        var randIdx = Math.floor(Math.random() * createdElement.videoMapping['sheena'].length);
        jsonObj.nodeArgs.nodeB.tGo.doors['1'].composer.pipeline1.videoUrl = 'http://img.youtube.com/vi/' + createdElement.videoMapping['sheena'][randIdx] + '/0.jpg';
      } else {
        console.log('Sheena does not have an image');
      }
    } else {
      console.log('Sheena unexpected json');
    }
    // C1
    if (jsonObj.nodeArgs.nodeC.tGo.doors['0'].composer.pipeline1.videoUrl !== undefined) {
      if (createdElement.videoMapping['felix']) {
        var randIdx = Math.floor(Math.random() * createdElement.videoMapping['felix'].length);
        jsonObj.nodeArgs.nodeC.tGo.doors['0'].composer.pipeline1.videoUrl = 'http://img.youtube.com/vi/' + createdElement.videoMapping['felix'][randIdx] + '/0.jpg';
      } else {
        console.log('Felix does not have an image');
      }
    } else {
      console.log('Felix unexpected json');
    }
    // C2
    if (jsonObj.nodeArgs.nodeC.tGo.doors['1'].composer.pipeline1.videoUrl !== undefined) {
      if (createdElement.videoMapping['eddie']) {
        var randIdx = Math.floor(Math.random() * createdElement.videoMapping['eddie'].length);
        jsonObj.nodeArgs.nodeC.tGo.doors['1'].composer.pipeline1.videoUrl = 'http://img.youtube.com/vi/' + createdElement.videoMapping['eddie'][randIdx] + '/0.jpg';
      } else {
        console.log('Eddie does not have an image');
      }
    } else {
      console.log('Eddie unexpected json');
    }
    
    var dataName = new Name(createdElement.ndnPublisherComponentObject.namePrefix);
    // Note: for now, the names are hard-coded, since namespace design is not fully discussed
    var cueComponent = new Name('cues');
    var nameSuffix = new Name(createdElement.cueId + '/go');
    dataName.append(createdElement.showid).append(cueComponent).appendVersion((new Date).getTime()).append(nameSuffix);
    
    if (createdElement.ndnPublisherComponentObject.wsOn()) {
      createdElement.goElement.className += ' video-control-clicked';
    } else {
      createdElement.goElement.className += ' video-control-problem';
    }
    
    componentObject.applyStyleFromParentDocument(createdElement.goElement);
    
    createdElement.content = JSON.stringify(jsonObj);
    createdElement.ndnPublisherComponentObject.publishContent(dataName, createdElement.content, false);
    
    setTimeout(function () {
      publishDoors(jsonObj, createdElement);
    }, 2000);
  }
  
  function jsonTraverse(obj, func, createdElement) {
    for (var i in obj) {
      func.apply(this, [i, obj, createdElement]);  
      if (obj[i] !== null && typeof(obj[i]) == "object") {
        jsonTraverse(obj[i], func, createdElement);
      }
    }
  }
  
  function registerEvents(createdElement) {
    createdElement.loadElement.addEventListener('click', function () {
      // TODO: referencing namePrefix like this is not ideal
      console.log('load does not do anything');
      
    });
    
    createdElement.goElement.addEventListener('click', function() {
      if (!createdElement.cueGoing && createdElement.cueReady) {
        // TODO: referencing namePrefix like this is not ideal
        var dataName = new Name(createdElement.ndnPublisherComponentObject.namePrefix);
        // Note: for now, the names are hard-coded, since namespace design is not fully discussed
        var cueComponent = new Name('cues');
        var nameSuffix = new Name(createdElement.cueId + '/go');
        dataName.append(createdElement.showid).append(cueComponent).appendVersion((new Date).getTime()).append(nameSuffix);
      
        createdElement.imageIdx = 0;
        publishDoors(createdElement.cueContent, createdElement);
        
        createdElement.goElement.className += ' video-control-clicked';
        componentObject.applyStyleFromParentDocument(createdElement.goElement);
        createdElement.cueGoing = true;
      } else {
        console.log('Cue is already going, or not ready yet!');
      }
    });
  }
  
  componentObject.createComponent(componentName, onCreate);
</script>

